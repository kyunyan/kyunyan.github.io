# 동시성

### 동시성이 필요한 이유 

동시성은 단일 스레드에서 밀접하게 사용되는 무엇과 언제를 분리켜 결합성을 없애는 필요한 전략이다.

이렇게 함으로써 처리량 향상될 수 있다. 한 유저의 요청을 처리하는 데에 1초가 가 걸리는 시스템이 있다고 가정을한다
이 시스템은 소수가 사용하는 시스템이라면 아주 빨리 반응을 할것이다
하지만 유저가 늘어남에 따라 모든 유저는 자신보다 먼저 도착한 요청이 끝날 때까지 기다려야만 한다. 이러한 경우 동시성이 여러 유저를 동시에 처리함으로써 처리량을 향상시킬 수 있다.

1. 미신과 오해
- 동시성은 성능을 항상 높여준다.
동시성은 때로 성능을 높여준다
대기시간이 아주 길어 여러 스레드가 프로세서를 공유 할 수 있거나, 여러 프로세서가 동시에 처리할 독립적인 계산이 충분히 많은 경우 에만 성능이 높아진다.

- 동시성을 구현해도 설계가 변하지 않는다
단일 스레드와 다중 스러데 시스템은 설계가 다르다

- 웹 또는 EJB 컨테이너를 사용하면 동시성을 이해할 필요가 없다.
실제 컨테이너가 어떻게 동작하는지 데드락 같은 문제를 피할수 있는지를 알아야한다.

- 동시성은 다소 부화를 유발한다.
- 동시성은 복잡하다
- 일반적으로 동시성 버그는 재현하기 어렵다
- 동시성을 구현하라면 흔히 근본적인 설계 전략을 재고해야 한다


- 모든 테스트를 실행한다.
- 중복을 없앤다.
- 프로그래머 의도를 표현한다.
- 클래스와 메소드의 수를 최소한 으로 줄인다.

2. 난관 
 ```java
   public class X{
   	    private int lastIdUsed;

        public int getNextId() {
            return ++lastIdUsed;
        }
   }
   
   ```

   결과는 총 3가지 이다.
   한 스레드는 43을, 다른 스레드는 44를 가져간다. 
   한 스레드는 44을, 다른 스레드는 43를 가져간다. 
   한 스레드는 43을, 다른 스레드는 43를 가져간다.
   위의 getNextId() 메서드는 8개의 자바 byte-code로 변환되며, 이를 두 스레드에서 실행하게 되면 총 12,870개의 코드 조합을 낼 수 있다. 그 중 얼마 안 되는 몇몇 조합이 위의 3가지 결과 중 마지막 결과를 낳게 된다.   

3. 동시성 방어 원칙
 - 클래스 함수수를 줄이는 것도 중요하지만 더 중요한 것은
 테스트 케이스를 만들고 중복을제거하고 의도롤 표현하는 작업이 더중요하다.
  
